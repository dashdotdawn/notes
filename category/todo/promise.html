<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>promise 实现 | _.dawn</title>
    <meta name="description" content="新闻发布署">
    
    
    <link rel="preload" href="/notes/assets/css/0.styles.9c1a28d7.css" as="style"><link rel="preload" href="/notes/assets/js/app.7fb44869.js" as="script"><link rel="preload" href="/notes/assets/js/29.6cc87f08.js" as="script"><link rel="prefetch" href="/notes/assets/js/15.0c721535.js"><link rel="prefetch" href="/notes/assets/js/2.9a15e329.js"><link rel="prefetch" href="/notes/assets/js/3.4efdfa39.js"><link rel="prefetch" href="/notes/assets/js/4.675a765e.js"><link rel="prefetch" href="/notes/assets/js/5.db1e46a4.js"><link rel="prefetch" href="/notes/assets/js/6.04ddd226.js"><link rel="prefetch" href="/notes/assets/js/7.7ae72a82.js"><link rel="prefetch" href="/notes/assets/js/8.4cdc1d80.js"><link rel="prefetch" href="/notes/assets/js/9.95701596.js"><link rel="prefetch" href="/notes/assets/js/10.0a4a605e.js"><link rel="prefetch" href="/notes/assets/js/11.9b69c166.js"><link rel="prefetch" href="/notes/assets/js/12.5f93cb25.js"><link rel="prefetch" href="/notes/assets/js/13.6e1c22e7.js"><link rel="prefetch" href="/notes/assets/js/14.b76bb14a.js"><link rel="prefetch" href="/notes/assets/js/16.118cf163.js"><link rel="prefetch" href="/notes/assets/js/17.d79e9bae.js"><link rel="prefetch" href="/notes/assets/js/18.621aab7a.js"><link rel="prefetch" href="/notes/assets/js/19.1bf38dd6.js"><link rel="prefetch" href="/notes/assets/js/20.3cd2c8c9.js"><link rel="prefetch" href="/notes/assets/js/21.d3c4697f.js"><link rel="prefetch" href="/notes/assets/js/22.2af2c9f4.js"><link rel="prefetch" href="/notes/assets/js/23.49b1fcd8.js"><link rel="prefetch" href="/notes/assets/js/24.e86d0b15.js"><link rel="prefetch" href="/notes/assets/js/25.85627c9c.js"><link rel="prefetch" href="/notes/assets/js/26.fde3b38f.js"><link rel="prefetch" href="/notes/assets/js/27.fbf19f8c.js"><link rel="prefetch" href="/notes/assets/js/28.0a9b6c96.js"><link rel="prefetch" href="/notes/assets/js/30.7bfe4d10.js"><link rel="prefetch" href="/notes/assets/js/31.50c13991.js"><link rel="prefetch" href="/notes/assets/js/32.a11d06ec.js"><link rel="prefetch" href="/notes/assets/js/33.c59f1385.js"><link rel="prefetch" href="/notes/assets/js/34.a8759261.js"><link rel="prefetch" href="/notes/assets/js/35.8e758eb9.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.9c1a28d7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">_.dawn</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>promise 实现</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/notes/category/todo/promise.html#_2-1-promise-states" class="sidebar-link">2.1 Promise States</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/notes/category/todo/promise.html#_2-2-the-then-method" class="sidebar-link">2.2 The then Method</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="promise-实现"><a href="#promise-实现" aria-hidden="true" class="header-anchor">#</a> promise 实现</h1> <blockquote><p>面试被问到了，说了下思路，回来撸一下完整的</p></blockquote> <p>跟着 <a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">promiseA+规范<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 一步步来，依次实现规范中的四个小节。</p> <h2 id="_2-1-promise-states"><a href="#_2-1-promise-states" aria-hidden="true" class="header-anchor">#</a> 2.1 Promise States</h2> <p>A promise must be in one of three states: pending, fulfilled, or rejected.</p> <ul><li>2.1.1. When pending, a promise:
<ul><li>2.1.1.1 may transition to either the fulfilled or rejected state.</li></ul></li> <li>2.1.2. When fulfilled, a promise:
<ul><li>2.1.2.1 must not transition to any other state.</li> <li>2.1.2.2 must have a value, which must not change.</li></ul></li> <li>2.1.3. When rejected, a promise:
<ul><li>2.1.3.1 must not transition to any other state.</li> <li>2.1.3.2 must have a reason, which must not change.</li></ul></li></ul> <p>Here, “must not change” means immutable identity (i.e. ===), but does not imply deep immutability.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
<span class="token keyword">const</span> <span class="token constant">FULFUILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>

<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>reason
  <span class="token keyword">this</span><span class="token punctuation">.</span>value
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">FULFUILLED</span>
      self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">REJECTED</span>
      self<span class="token punctuation">.</span>reason <span class="token operator">=</span> reason
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-2-the-then-method"><a href="#_2-2-the-then-method" aria-hidden="true" class="header-anchor">#</a> 2.2 The then Method</h2> <p>A promise must provide a then method to access its current or eventual value or reason.</p> <p>A promise’s then method accepts two arguments:</p> <p>promise.then(onFulfilled, onRejected)
Both onFulfilled and onRejected are optional arguments:
If onFulfilled is not a function, it must be ignored.
If onRejected is not a function, it must be ignored.
If onFulfilled is a function:
it must be called after promise is fulfilled, with promise’s value as its first argument.
it must not be called before promise is fulfilled.
it must not be called more than once.
If onRejected is a function,
it must be called after promise is rejected, with promise’s reason as its first argument.
it must not be called before promise is rejected.
it must not be called more than once.
onFulfilled or onRejected must not be called until the execution context stack contains only platform code. [3.1].
onFulfilled and onRejected must be called as functions (i.e. with no this value). [3.2]
then may be called multiple times on the same promise.
If/when promise is fulfilled, all respective onFulfilled callbacks must execute in the order of their originating calls to then.
If/when promise is rejected, all respective onRejected callbacks must execute in the order of their originating calls to then.
then must return a promise [3.3].</p> <p>promise2 = promise1.then(onFulfilled, onRejected);
If either onFulfilled or onRejected returns a value x, run the Promise Resolution Procedure [[Resolve]](promise2, x).
If either onFulfilled or onRejected throws an exception e, promise2 must be rejected with e as the reason.
If onFulfilled is not a function and promise1 is fulfilled, promise2 must be fulfilled with the same value as promise1.
If onRejected is not a function and promise1 is rejected, promise2 must be rejected with the same reason as promise1.</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/notes/assets/js/29.6cc87f08.js" defer></script><script src="/notes/assets/js/app.7fb44869.js" defer></script>
  </body>
</html>
